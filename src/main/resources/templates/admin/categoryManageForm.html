<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>카테고리 관리</title>
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="/css/admin.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
</head>
<body>
<div class="container">
    <!-- 헤더 -->
    <div th:replace="~{fragments/header :: header}"></div>

    <div class="row g-4 p-4">
        <!-- 사이드 메뉴 바 -->
        <div class="col-auto bg-light border rounded p-3" style="width: 250px;">
            <h4 class="text-center">메뉴</h4>
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link" href="/admin/members">회원 관리</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="/bookManage/books">도서 관리</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/admin/reviewManage">리뷰 관리</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/admin/coupon">쿠폰 발행</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/admin/point">포인트 관리</a>
                </li>
            </ul>
        </div>

        <!-- 카테고리 목록 및 카테고리 등록 폼 -->
        <div class="col-9">
            <h2 class="mb-4" style="text-align: left;">카테고리 등록</h2>

            <div th:if="${errors}" class="alert alert-danger text-center" role="alert">
                <div th:each="error : ${errors}">
                    <p th:text="${error}"></p>
                </div>
            </div>

            <form action="/admin/categoryManage" method="post">
                <div class="mb-3">
                    <label for="categoryName" class="form-label">Category Name</label>
                    <input type="text" class="form-control" id="categoryName" name="categoryName" required
                           th:value="${firstCategoryRequestDTO != null ? firstCategoryRequestDTO.categoryName() : ''}">
                    <div class="form-text">Category name is required and cannot be empty.</div>
                </div>

                <button type="submit" class="btn" style="background-color: #9E8DBF; color: white; width: 100%;">Register
                    Category
                </button>
            </form>

            <div class="mt-5"></div>

            <!-- 카테고리 목록 -->
            <h3 class="mt-4" style="text-align: left;">카테고리 목록</h3>
            <table class="table table-bordered mt-2">
                <thead class="table-light">
                <tr>
                    <th>카테고리 아이디</th>
                    <th>카테고리 이름</th>
                    <th>부모 카테고리</th>
                    <th>부모 카테고리 수정</th>
                    <th>삭제</th>
                </tr>
                </thead>
                <tbody>
                <!-- 모든 카테고리 목록 -->
                <tr th:each="category : ${pagedCategories}">
                    <!-- 카테고리 아이디 -->
                    <td th:text="${category.categoryId}"></td>
                    <!-- 카테고리 이름 -->
                    <td><span th:text="${category.categoryName}"></span></td>
                    <!-- 부모 카테고리 아이디와 이름 결합 -->
                    <td>
                        <span th:text="${category.parentCategory != null ? category.parentCategory.categoryName : '없음'}"></span>
                    </td>
                    <td>
                        <form action="/admin/categoryManage/add" method="post">
                            <!-- 카테고리 ID를 hidden input으로 전송 -->
                            <input type="hidden" name="subCategoryId" th:value="${category.categoryId}">
                            <!-- 드롭다운에서 선택된 부모 카테고리 ID는 자동으로 전송됨 -->
                            <div class="d-flex align-items-center">
                                <!-- 드롭다운 -->
                                <div class="me-2">
                                    <select class="form-select" name="categoryId">
                                        <option th:each="parentCategory : ${unPagedCategories}"
                                                th:value="${parentCategory.categoryId}"
                                                th:text="${parentCategory.categoryName}"
                                                th:selected="${category.parentCategory != null && category.parentCategory.categoryId == parentCategory.categoryId}"
                                                th:if="${parentCategory.parentCategory == null && parentCategory.categoryId != category.categoryId}">
                                        </option>
                                    </select>
                                </div>
                                <!-- 수정 버튼 -->
                                <div>
                                    <button type="submit" class="btn"
                                            style="background-color: #9E8DBF; color: white;"
                                            th:disabled="${#lists.contains(categoriesWithSubCategories, category.categoryId)}">
                                        수정
                                    </button>
                                </div>
                            </div>
                        </form>
                    </td>
                    <td>
                        <form th:action="@{/admin/categoryManage/{categoryId}(categoryId=${category.categoryId})}"
                              method="post"
                              onsubmit="return confirm('정말로 이 카테고리를 삭제하시겠습니까?');">
                            <input type="hidden" name="categoryId" th:value="${category.categoryId}">
                            <button type="submit" class="btn btn-danger">삭제</button>
                        </form>

                    </td>
                </tr>
                </tbody>
            </table>


        </div>
    </div>

    <!-- 페이지 네비게이션 -->
    <nav aria-label="Page navigation example" th:if="${totalPages > 0}">
        <div class="pagination justify-content-center">
            <!-- 이전 페이지 버튼 -->
            <span class="page-item" th:classappend="${currentPage == 1} ? 'disabled'">
                <a class="page-link"
                   th:href="@{'/admin/categoryManage'(page=${currentPage - 1 > 0 ? currentPage - 1 : 1})}"
                   aria-label="Previous">
                    <span aria-hidden="true">&laquo;</span>
                </a>
            </span>

            <!-- 페이지 번호 버튼 -->
            <span class="page-item" th:each="i : ${#numbers.sequence(1, totalPages)}"
                  th:classappend="${i eq currentPage} ? 'active'">
                <a class="page-link"
                   th:text="${i}"
                   th:href="@{'/admin/categoryManage'(page=${i})}"
                   style="background-color: #9E8DBF; color: white;">${i}</a>
            </span>

            <!-- 다음 페이지 버튼 -->
            <span class="page-item" th:classappend="${currentPage == totalPages} ? 'disabled'">
                <a class="page-link"
                   th:href="@{'/admin/categoryManage'(page=${currentPage + 1 <= totalPages ? currentPage + 1 : totalPages})}"
                   aria-label="Next">
                    <span aria-hidden="true">&raquo;</span>
                </a>
            </span>
        </div>
    </nav>
</div>

<!-- 풋터 -->
<div th:replace="~{fragments/footer :: footer}"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
