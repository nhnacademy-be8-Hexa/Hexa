<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>도서 등록</title>
  <!-- 반응형 디자인을 위한 뷰포트 메타 태그 추가 -->
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet" href="/css/styles.css">
  <link rel="stylesheet" href="/css/admin.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css">
  <!-- Bootstrap Icons (옵션) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <!-- Bootstrap Dropdown Submenu CSS -->
  <style>
    /* Dropdown Submenu */
    .dropdown-submenu {
      position: relative;
    }

    .dropdown-submenu .dropdown-menu {
      top: 0;
      left: 100%;
      margin-left: .1rem;
      margin-right: .1rem;
    }

    /* Checkbox Label Alignment */
    .dropdown-item input[type="checkbox"] {
      margin-right: 0.5rem;
    }
  </style>
</head>
<body>
<div class="container">
  <!-- 헤더 -->
  <div th:replace="~{fragments/header :: header}"></div>

  <div class="container-fluid d-flex gap-4 p-4 align-items-start">
    <!-- 사이드 메뉴 바 -->
    <div th:replace="~{fragments/admin :: admin}" class="col-md-3"></div>

    <!-- 도서 등록 컨텐츠 -->
    <div class="col">
      <h2>태그 등록</h2>

      <form id="bookCreateForm"
            th:object="${tagRequestDTO}"
            th:action="@{/admin/tagManage/add}"
            method="post">
        <!-- 에러 메시지 -->
        <div th:if="${#fields.hasErrors('*')}" class="alert alert-danger">
          <ul>
            <li th:each="err : ${#fields.errors('*')}" th:text="${err}"></li>
          </ul>
        </div>

        <!-- 태그 이름 -->
        <div class="mb-3">
          <label for="tagName" class="form-label">이름:</label>
          <input type="text" id="tagName" name="tagName" class="form-control"
                 th:field="*{tagName}" maxlength="30"/>
          <div class="text-danger" th:if="${#fields.hasErrors('tagName')}"
               th:errors="*{tagName}">이름 오류</div>
        </div>




        <button type="submit" class="btn btn-primary">등록</button>
        <a href="/admin/tagManage" class="btn btn-secondary">취소</a>
      </form>
    </div>
  </div>
</div>



<!-- 푸터 -->
<div th:replace="~{fragments/footer :: footer}"></div>

<!-- Toast UI Editor JS -->
<script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>
<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
<script th:inline="javascript">
  document.addEventListener("DOMContentLoaded", function () {
    const editorContainer = document.querySelector('#editor');
    const hiddenContent = document.querySelector('#content');

    if (!editorContainer) {
      console.error('Editor container not found.');
      return;
    }

    const initialContent = hiddenContent.value;

    const editor = new toastui.Editor({
      el: editorContainer,
      height: '500px',
      initialEditType: 'markdown',
      previewStyle: 'vertical',
      initialValue: initialContent,
      hooks: {
        addImageBlobHook: (blob, callback) => {
          const formData = new FormData();
          formData.append('image', blob);

          fetch('/upload-image', {
            method: 'POST',
            body: formData,
          })
                  .then(response => response.json())
                  .then(data => {
                    if (data.url) {
                      callback(data.url, 'Image');
                    } else {
                      alert('이미지 업로드 실패');
                      callback('', 'Image upload failed');
                    }
                  })
                  .catch(err => {
                    console.error('Error uploading image:', err);
                    callback('', 'Image upload failed');
                  });
        }
      }
    });

    const form = document.getElementById('bookCreateForm');
    form.addEventListener('submit', function () {
      hiddenContent.value = editor.getMarkdown();
    });

    // 출판사 추가 폼 처리
    const addPublisherForm = document.getElementById('addPublisherForm');
    const addPublisherModalElement = document.getElementById('addPublisherModal');
    const addPublisherModal = new bootstrap.Modal(addPublisherModalElement); // Modal 인스턴스 초기화

    addPublisherForm.addEventListener('submit', function (event) {
      event.preventDefault();

      const publisherNameInput = document.getElementById('publisherName');
      const publisherName = publisherNameInput.value.trim();
      const publisherError = document.getElementById('publisherError');

      if (!publisherName) {
        publisherError.textContent = '출판사 이름을 입력해주세요.';
        publisherError.style.display = 'block';
        return;
      }

      // 출판사 추가 API 호출
      fetch('/admin/bookManage/publishers', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ publisherName: publisherName }),
      })
              .then(response => {
                if (!response.ok) {
                  return response.text().then(text => { throw new Error(text); });
                }
                return response.json();
              })
              .then(data => {
                // 성공적으로 추가된 경우, 출판사 목록을 업데이트하고 선택
                const publisherSelect = document.getElementById('publisherId');
                const newOption = document.createElement('option');
                newOption.value = data.publisherId;
                newOption.textContent = data.publisherName;
                newOption.selected = true;
                publisherSelect.appendChild(newOption);

                // 모달 닫기
                addPublisherModal.hide();

                // 입력 필드 초기화 및 에러 메시지 숨김
                publisherNameInput.value = '';
                publisherError.style.display = 'none';
              })
              .catch(error => {
                console.error('Error adding publisher:', error);
                publisherError.textContent = error.message || '출판사 추가 중 오류가 발생했습니다.';
                publisherError.style.display = 'block';
              });
    });

    // 카테고리 드롭다운 선택 처리
    const categoryDropdown = document.getElementById('categoryDropdown');
    const categoryCheckboxes = document.querySelectorAll('.category-checkbox, .sub-category-checkbox');

    categoryCheckboxes.forEach(function(checkbox) {
      checkbox.addEventListener('change', function() {
        // 부모-자식 관계 처리
        if (this.classList.contains('sub-category-checkbox')) {
          const parentId = this.getAttribute('data-parent-id');
          const parentCheckbox = document.getElementById('category-' + parentId);

          if (this.checked) {
            // 하위 카테고리가 선택되면 부모 카테고리도 선택
            if (parentCheckbox && !parentCheckbox.checked) {
              parentCheckbox.checked = true;
            }
          } else {
            // 하위 카테고리가 해제되면 다른 하위 카테고리가 선택되어 있는지 확인
            const relatedSubCategories = document.querySelectorAll(`.sub-category-checkbox[data-parent-id="${parentId}"]`);
            const anySubChecked = Array.from(relatedSubCategories).some(cb => cb.checked);
            if (!anySubChecked) {
              // 다른 하위 카테고리가 선택되지 않았다면 부모 카테고리도 해제
              if (parentCheckbox && parentCheckbox.checked) {
                parentCheckbox.checked = false;
              }
            }
          }
        }

        updateCategoryDropdown();
      });
    });

    function updateCategoryDropdown() {
      const selectedCategories = [];
      categoryCheckboxes.forEach(function(checkbox) {
        if (checkbox.checked) {
          const label = document.querySelector(`label[for="${checkbox.id}"]`);
          if (label) {
            selectedCategories.push(label.textContent.trim());
          }
        }
      });

      if (selectedCategories.length > 0) {
        categoryDropdown.textContent = selectedCategories.join(', ');
      } else {
        categoryDropdown.textContent = '카테고리 선택';
      }
    }
  });
</script>
</div>
</body>
</html>
