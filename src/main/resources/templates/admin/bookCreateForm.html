<!-- src/main/resources/templates/admin/bookCreateForm.html -->
<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>도서 등록</title>
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="/css/admin.css">
    <!-- Bootstrap CSS 추가 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- TOAST UI Editor CSS (CDN 사용) -->
    <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css">
</head>
<body>
<div class="container">
    <!-- 헤더 포함 -->
    <div th:replace="~{fragments/header :: header}"></div>

    <!-- 전체 레이아웃 -->
    <div class="row g-4 p-4">
        <!-- 사이드 메뉴 바 -->
        <div class="col-auto bg-light border rounded p-3" style="width: 250px;">
            <h4 class="text-center">메뉴</h4>
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link" href="/admin/members">회원 관리</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="/admin/bookManage/books">도서 관리</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/admin/reviewManage">리뷰 관리</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/admin/coupon">쿠폰 발행</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/admin/point">포인트 관리</a>
                </li>
            </ul>
        </div>

        <!-- 메인 컨텐츠 -->
        <div class="col">
            <h2>도서 등록</h2>

            <!-- 에러 메시지 표시 -->
            <div th:if="${#fields.hasErrors('*')}" class="alert alert-danger">
                <ul>
                    <li th:each="err : ${#fields.errors('*')}" th:text="${err}"></li>
                </ul>
            </div>

            <!-- 도서 등록 폼 -->
            <form id="bookCreateForm"
                  th:object="${bookRequestDTO}"
                  th:action="@{/admin/bookManage/new}"
                  method="post">
                <!-- 도서 제목 -->
                <div class="mb-3">
                    <label for="bookTitle" class="form-label">제목:</label>
                    <input type="text" id="bookTitle" name="bookTitle" class="form-control"
                           th:field="*{bookTitle}"
                           required maxlength="100"/>
                    <div class="text-danger" th:if="${#fields.hasErrors('bookTitle')}"
                         th:errors="*{bookTitle}">제목 오류</div>
                </div>

                <!-- 도서 설명 -->
                <div class="mb-3">
                    <label for="bookDescription" class="form-label">설명:</label>
                    <div id="editor"></div>
                    <!-- 에디터의 내용을 저장할 숨겨진 textarea -->
                    <textarea id="content" name="bookDescription" style="display:none;"
                              th:field="*{bookDescription}"></textarea>
                    <div class="text-danger" th:if="${#fields.hasErrors('bookDescription')}"
                         th:errors="*{bookDescription}">설명 오류</div>
                </div>

                <!-- 도서 가격 -->
                <div class="mb-3">
                    <label for="bookPrice" class="form-label">가격:</label>
                    <input type="number" id="bookPrice" name="bookPrice" class="form-control"
                           th:field="*{bookPrice}"
                           required min="1"/>
                    <div class="text-danger" th:if="${#fields.hasErrors('bookPrice')}"
                         th:errors="*{bookPrice}">가격 오류</div>
                </div>

                <!-- 도서 포장 가능 여부 -->
                <div class="mb-3 form-check">
                    <input type="checkbox" id="bookWrappable" name="bookWrappable" class="form-check-input"
                           th:field="*{bookWrappable}"/>
                    <label for="bookWrappable" class="form-check-label">포장 가능</label>
                </div>

                <!-- 도서 상태 -->
                <div class="mb-3">
                    <label for="bookStatusId" class="form-label">도서 상태:</label>
                    <select id="bookStatusId" name="bookStatusId" class="form-select" required
                            th:field="*{bookStatusId}">
                        <option value="" disabled selected>선택하세요</option>
                        <option value="AVAILABLE">재고 있음</option>
                        <option value="OUT_OF_STOCK">품절</option>
                        <!-- 추가적인 상태 옵션 -->
                    </select>
                    <div class="text-danger" th:if="${#fields.hasErrors('bookStatusId')}"
                         th:errors="*{bookStatusId}">도서 상태 오류</div>
                </div>

                <!-- 도서 출판사 ID -->
                <div class="mb-3">
                    <label for="publisherId" class="form-label">출판사:</label>
                    <select id="publisherId" name="publisherId" class="form-select" required
                            th:field="*{publisherId}">
                        <option value="" disabled selected>선택하세요</option>
                        <option th:each="publisher : ${publishers}"
                                th:value="${publisher.publisherId}"
                                th:text="${publisher.publisherName}"></option>
                    </select>
                    <div class="text-danger" th:if="${#fields.hasErrors('publisherId')}"
                         th:errors="*{publisherId}">출판사 오류</div>
                </div>

                <!-- 도서 ISBN -->
                <div class="mb-3">
                    <label for="bookIsbn" class="form-label">ISBN:</label>
                    <input type="text" id="bookIsbn" name="bookIsbn" class="form-control"
                           th:field="*{bookIsbn}"
                           required pattern="\d{10}(\d{3})?"
                           title="ISBN은 10자리 또는 13자리 숫자여야 합니다."/>
                    <div class="text-danger" th:if="${#fields.hasErrors('bookIsbn')}"
                         th:errors="*{bookIsbn}">ISBN 오류</div>
                </div>

                <!-- 도서 출판일 -->
                <div class="mb-3">
                    <label for="bookPubDate" class="form-label">출판일:</label>
                    <input type="date" id="bookPubDate" name="bookPubDate" class="form-control"
                           th:field="*{bookPubDate}"
                           required/>
                    <div class="text-danger" th:if="${#fields.hasErrors('bookPubDate')}"
                         th:errors="*{bookPubDate}">출판일 오류</div>
                </div>

                <!-- 도서 원가 -->
                <div class="mb-3">
                    <label for="bookOriginPrice" class="form-label">원가:</label>
                    <input type="number" id="bookOriginPrice" name="bookOriginPrice" class="form-control"
                           th:field="*{bookOriginPrice}"
                           required min="1"/>
                    <div class="text-danger" th:if="${#fields.hasErrors('bookOriginPrice')}"
                         th:errors="*{bookOriginPrice}">원가 오류</div>
                </div>

                <!-- 도서 수량 -->
                <div class="mb-3">
                    <label for="bookAmount" class="form-label">수량:</label>
                    <input type="number" id="bookAmount" name="bookAmount" class="form-control"
                           th:field="*{bookAmount}"
                           required min="0"/>
                    <div class="text-danger" th:if="${#fields.hasErrors('bookAmount')}"
                         th:errors="*{bookAmount}">수량 오류</div>
                </div>

                <!-- 폼 제출 및 취소 버튼 -->
                <button type="submit" class="btn btn-primary">등록</button>
                <a href="/admin/bookManage/books" class="btn btn-secondary">취소</a>
            </form>
        </div>
    </div>

    <!-- 풋터 포함 -->
    <div th:replace="~{fragments/footer :: footer}"></div>

    <!-- TOAST UI Editor JS (CDN 사용) -->
    <script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>
    <!-- Bootstrap JS 추가 (필요 시) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>

    <!-- JavaScript 내에 Thymeleaf 변수 사용을 위해 th:inline="javascript" 설정 -->
    <script th:inline="javascript">
        /*<![CDATA[*/
        document.addEventListener("DOMContentLoaded", function() {
            const editorContainer = document.querySelector('#editor');
            const initialContent = /*[[${bookRequestDTO.bookDescription}]]*/ '';

            const editor = toastui.Editor.create(editorContainer, {
                height: '500px',
                initialEditType: 'markdown', // 'markdown' 또는 'wysiwyg'
                previewStyle: 'vertical',
                useCommandShortcut: true,
                initialValue: initialContent,
                hooks: {
                    addImageBlobHook: (blob, callback) => {
                        const formData = new FormData();
                        formData.append('image', blob);

                        fetch('/upload-image', {
                            method: 'POST',
                            body: formData,
                        })
                            .then(response => response.json())
                            .then(data => {
                                if (data.url) {
                                    callback(data.url, 'Image');
                                } else {
                                    callback('', 'Image upload failed');
                                    alert('이미지 업로드에 실패했습니다.');
                                }
                            })
                            .catch(error => {
                                console.error('Error uploading image:', error);
                                callback('', 'Image upload failed');
                                alert('이미지 업로드 중 오류가 발생했습니다.');
                            });
                    }
                }
            });

            // 에디터에 기존 내용 설정
            editor.setMarkdown(initialContent);

            // 폼 제출 시 에디터 내용을 hidden textarea에 저장
            const form = document.getElementById('bookCreateForm');
            form.addEventListener('submit', function(e) {
                document.getElementById('content').value = editor.getMarkdown();
            });
        });
        /*]]>*/
    </script>
</div>
</body>
</html>
