<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cart</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
<div class="container mt-5">

    <div th:replace="fragments/header :: header"></div>

    <!-- 전체 선택 및 선택 삭제 버튼 -->
    <button class="cart-button" onclick="selectAllItems()">전체 선택</button>
    <button class="cart-button" onclick="deleteSelectedItems()">선택 삭제</button>

    <hr>

    <!-- 장바구니 목록 -->
    <div class="cart-list" id="cart-list">
        <!-- 장바구니 품목이 여기 렌더링됩니다 -->
    </div>

    <!-- 장바구니 푸터 -->
    <div class="cart-footer d-flex justify-content-between align-items-center mt-4">
        <div>배송비: 무료</div>
        <div>총합계: <span id="total-price">0원</span></div>
        <button class="btn btn-success">구매하기</button>
    </div>

    <!-- 풋터 -->
    <div th:replace="fragments/footer :: footer"></div>

</div>
<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>

<!-- 장바구니 스크립트 -->
<script>
    let carts = [];

    // 서버에서 장바구니 데이터 가져오기
    async function fetchCart() {
        const response = await fetch('http://localhost:8080/api/cart', {
            method: 'GET',
            credentials: 'include' // 세션 쿠키 포함
        });
        if (!response.ok) {
            throw new Error('Failed to fetch cart');
        }
        return await response.json();
    }

    // 서버에 장바구니 항목 추가
    async function addToCart(item) {
        const response = await fetch('http://localhost:8080/api/cart', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify(item)
        });
        if (!response.ok) {
            throw new Error('Failed to add item to cart');
        }
    }

    // 서버에서 특정 항목 삭제
    async function deleteCartItem(cartId) {
        const response = await fetch(`http://localhost:8080/api/cart/${cartId}`, {
            method: 'DELETE',
            credentials: 'include'
        });
        if (!response.ok) {
            throw new Error('Failed to delete item from cart');
        }
    }

    // 페이지 로드 시 장바구니 데이터 로드
    async function loadCart() {
        try {
            carts = await fetchCart();
            console.log('Loaded carts from server:', carts);
        } catch (error) {
            console.error('Failed to load carts:', error);
            carts = [];
        }
    }

    // 장바구니 렌더링
    function renderCart() {
        const cartList = document.getElementById('cart-list');
        cartList.innerHTML = ''; // 기존 내용 초기화

        if (carts.length === 0) {
            cartList.innerHTML = '<p>장바구니가 비어 있습니다.</p>';
            document.getElementById('total-price').innerText = '0원';
            return;
        }

        carts.forEach(cart => {
            const cartItem = document.createElement('div');
            cartItem.className = 'cart-item';
            cartItem.id = `cart-item-${cart.cartId}`;

            cartItem.innerHTML = `
                <div class="d-flex align-items-center">
                    <input type="checkbox" class="cart-checkbox" id="check${cart.cartId}" value="${cart.cartId}" />
                    <img src="${cart.imageUrl}" alt="${cart.bookTitle}" width="80" height="120" style="cursor: pointer;" onclick="goToBookPage(${cart.bookId})" />
                    <div class="cart-book-info">
                        <div class="book-title" onclick="goToBookPage(${cart.bookId})" style="cursor: pointer;">${cart.bookTitle}</div>
                        <div class="book-price">가격: ${cart.bookPrice.toLocaleString()}원</div>
                        <div class="book-quantity">수량: ${cart.quantity}</div>
                    </div>
                </div>
                <button class="cart-button" onclick="removeItem(${cart.cartId})">삭제</button>
            `;

            cartList.appendChild(cartItem);
        });

        updateTotalPrice();
    }

    // 책 클릭 시 상세 페이지로 이동
    function goToBookPage(bookId) {
        window.location.href = `/book/${bookId}`;
    }

    // 단일 항목 삭제
    async function removeItem(cartId) {
        if (!confirm('정말로 삭제하시겠습니까?')) {
            return;
        }

        try {
            await deleteCartItem(cartId);
            carts = carts.filter(item => item.cartId !== cartId);
            renderCart();
        } catch (error) {
            console.error('Failed to remove item:', error);
        }
    }

    // 선택된 항목 삭제
    async function deleteSelectedItems() {
        const selectedCheckboxes = document.querySelectorAll('.cart-checkbox:checked');
        const selectedIds = Array.from(selectedCheckboxes).map(chk => parseInt(chk.value, 10));

        if (selectedIds.length === 0) {
            alert('삭제할 항목이 선택되지 않았습니다.');
            return;
        }

        if (!confirm('선택된 항목들을 정말로 삭제하시겠습니까?')) {
            return;
        }

        try {
            for (const cartId of selectedIds) {
                await deleteCartItem(cartId);
            }
            carts = carts.filter(item => !selectedIds.includes(item.cartId));
            renderCart();
        } catch (error) {
            console.error('Failed to delete selected items:', error);
        }
    }

    // 전체 선택/해제
    function selectAllItems() {
        const checkboxes = document.querySelectorAll('.cart-checkbox');
        const allChecked = Array.from(checkboxes).every(chk => chk.checked);

        checkboxes.forEach(chk => (chk.checked = !allChecked));
    }

    // 총합계 업데이트
    function updateTotalPrice() {
        const totalPriceElement = document.getElementById('total-price');
        let total = 0;

        carts.forEach(item => {
            total += item.bookPrice * item.quantity;
        });

        totalPriceElement.innerText = `${total.toLocaleString()}원`;
    }

    // 페이지 로드 시 데이터 로드 및 렌더링
    window.onload = async function () {
        await loadCart();
        renderCart();
    };
</script>
</body>
</html>
